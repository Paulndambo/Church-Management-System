{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="page-header d-flex justify-content-between align-items-center flex-wrap">
        <h2>Section Reports</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newYearlySectionReportsModal">
            <i class="fas fa-plus"></i> Create Church Reports
        </button>
    </div>

    <!-- Filter Section -->
    <div class="card filter-card mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <!-- Filter by Section -->
                <div class="col-md-6 col-lg-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-church me-2"></i>Filter by Section
                    </label>
                    <select class="form-control" id="sectionSelect">
                        <option value="">-- Select a section --</option>
                        {% for section in sections %}
                            <option value="{{ section.id }}"
                                {% if request.GET.section == section.id|stringformat:"s" %}selected{% endif %}>
                                {{ section.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filter by Year -->
                <div class="col-md-6 col-lg-4">
                    <label class="form-label fw-bold">
                        <i class="fas fa-calendar me-2"></i>Filter by Year
                    </label>
                    <select class="form-control" id="yearSelect">
                        <option value="">-- Select a year --</option>
                        {% for year in years %}
                            <option value="{{ year }}"
                                {% if request.GET.year == year|stringformat:"s" %}selected{% endif %}>
                                {{ year }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Reset Button -->
                <div class="col-md-6 col-lg-4">
                    <button id="resetFiltersBtn" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-undo"></i> Reset Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Display -->
    <div class="row" id="reportsContainer">
        {% for report in reports %}
        <div class="col-md-6 col-lg-4 mb-4 report-item" data-section="{{ report.section.id }}" data-year="{{ report.year }}">
            <div class="card section-card h-100">
                <div class="card-body">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title fw-bold">Section: {{ report.section }}</h5>
                        <span class="badge bg-secondary">{{ report.year }}</span>
                    </div>
                    <p class="card-text"><strong>District:</strong> {{ report.section.district }}</p>
                    <p class="card-text"><strong>Created:</strong> {{ report.created_at }}</p>
                    <div class="mt-3">
                        <a href="{% url 'section-report-detail' report.id %}" class="btn btn-info btn-sm w-100">
                            <i class="fas fa-eye"></i> Fill Report
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted mt-4">
            <p>No reports found for the selected filters.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% include "districts/section_reports/new_report.html" %}
{% endblock content %}

{% block additional_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sectionSelect = document.getElementById('sectionSelect');
    const yearSelect = document.getElementById('yearSelect');
    const resetBtn = document.getElementById('resetFiltersBtn');

    function applyFilters() {
        const section = sectionSelect.value;
        const year = yearSelect.value;

        const params = new URLSearchParams(window.location.search);
        if (section) params.set('section', section); else params.delete('section');
        if (year) params.set('year', year); else params.delete('year');

        window.location.search = params.toString();
    }

    sectionSelect.addEventListener('change', applyFilters);
    yearSelect.addEventListener('change', applyFilters);

    // Reset filters handler
    resetBtn.addEventListener('click', function() {
        sectionSelect.value = "";
        yearSelect.value = "";
        window.location.href = window.location.pathname; // Reload without filters
    });
});
</script>
{% endblock additional_scripts %}
