{% extends "base.html" %}

{% block content %}
<!-- Stats Row -->
<div class="dashboard">
    <div class="row g-4 mb-4">
        <input type="number" id="yearFilter" name="yearFilter" value="2025" hidden>
    </div>

    <div class="row g-4 mb-4">
    <div class="col-xl-6 col-md-6">
        <div class="card card-stat h-80">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-church-primary">TOTAL MEMBERS</h6>
                        <h3 class="text-church-secondary">{{total_members}}</h3>
                    </div>
                    <i class="fas fa-users stats-icon text-church-gold"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class="card card-stat h-80">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-church-primary">TOTAL TITHES</h6>
                        <h3 class="text-church-secondary">{{tithes_total}} Kes</h3>
                    </div>
                    <i class="fas fa-church stats-icon text-church-gold"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class="card card-stat h-80">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-church-primary">DEPARTMENT SAVINGS</h6>
                        <h3 class="text-church-secondary">{{total_department_savings}} Kes.</h3>
                    </div>
                    <i class="fas fa-piggy-bank stats-icon text-church-gold"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6">
        <div class="card card-stat h-80">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-church-primary">TOTAL OFFERINGS</h6>
                        <h3 class="text-church-secondary">{{total_offerings}} Kes</h3>
                    </div>
                    <i class="fas fa-hand-holding-heart stats-icon text-church-gold"></i>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Monthly Income Overview</h5>
            <canvas id="monthlyFinancesOverviewChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Gender Distribution</h5>
            <canvas id="genderDistributionChart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Attendance Overview</h5>
            <canvas id="attendanceOverviewChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Attendance Distribution</h5>
            <canvas id="serviceAttendanceChart"></canvas>
        </div>
    </div>
</div>
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Department Savings Overview</h5>
            <canvas id="departmentSavingsOverviewChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Department Savings Distribution</h5>
            <canvas id="departmentSavingsDistributionChart"></canvas>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Church Ledger Tracking</h5>
            <canvas id="incomeExpenseChart"></canvas>
        </div>
    </div>
    <div class="col-md-4">
        <div class="chart-container">
            <h5 class="chart-title fw-bold">Ledger Distribution</h5>
            <canvas id="financesDistributionChart"></canvas>
        </div>
    </div>
</div>
</div>
   
{% endblock content %}

{% block additional_scripts %}
<script>
    
    // Attendance Chart
    let attendanceOverviewChart;
    let serviceAttendanceChart;
    let monthlyFinancesOverviewChart;
    let incomeExpenseChart;
    let financesDistributionChart;
    let departmentSavingsOverviewChart;
    let departmentSavingsDistributionChart;
    let genderDistributionChart;

    function getRandomColor() {
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        return `rgba(${r}, ${g}, ${b}, 1)`;
    }

    // Define distinct colors for each dataset label
    const colorMap = {
        "Male": {
            borderColor: "rgba(54, 162, 235, 1)",       // Blue
            backgroundColor: "rgba(54, 162, 235, 0.2)", // Light blue fill
        },
        "Female": {
            borderColor: "rgba(255, 99, 132, 1)",       // Red
            backgroundColor: "rgba(255, 99, 132, 0.2)", // Light red fill
        },
        "Overall Attendance": {
            borderColor: "rgba(75, 192, 192, 1)",       // Teal
            backgroundColor: "rgba(0, 0, 0, 0)",        // No fill
        },
    };
     

    const initialData = {
        service_attendance: {
            labels: JSON.parse('{{ service_attendance.labels|safe }}'),
            attendances: JSON.parse('{{ service_attendance.attendances|safe }}'),
        },
        general_attendance_metrics: {
            labels: JSON.parse('{{ general_attendance_metrics.labels|safe }}'),
            datasets: JSON.parse('{{ general_attendance_metrics.datasets|safe }}'),
        },
        net_financials: {
            labels: JSON.parse('{{ net_financials.labels|safe }}'),
            data: JSON.parse('{{ net_financials.data|safe }}'),
        },
        monthly_finances: {
            labels: JSON.parse('{{ monthly_finances.labels|safe }}'),
            offerings: JSON.parse('{{ monthly_finances.offerings|safe }}'),
            donations: JSON.parse('{{ monthly_finances.donations|safe }}'),
            tithes: JSON.parse('{{ monthly_finances.tithes|safe }}'),
        },
        income_expense: {
            labels: JSON.parse('{{ income_expense.labels|safe }}'),
            income: JSON.parse('{{ income_expense.income|safe }}'),
            expense: JSON.parse('{{ income_expense.expense|safe }}')
        },
        attendances: {
            labels: JSON.parse('{{ attendances.labels|safe }}'),
            counts: JSON.parse('{{ attendances.counts|safe }}')
        },
        monthly_department_savings: {
            labels: JSON.parse('{{ monthly_department_savings.labels|safe }}'),
            savings: JSON.parse('{{ monthly_department_savings.savings|safe }}'),
        },
        monthly_department_savings_metrics: {
            labels: JSON.parse('{{ monthly_department_savings_metrics.labels|safe }}'),
            savings: JSON.parse('{{ monthly_department_savings_metrics.savings|safe }}'),
        },
        gender_distribution: {
            labels: JSON.parse('{{ gender_distribution.labels|safe }}'),
            counts: JSON.parse('{{ gender_distribution.counts|safe }}')
        }
    };

      function initCharts(yearData) {
        const serviceAttendanceCtx = document.getElementById('serviceAttendanceChart').getContext('2d');
        const monthlyFinancesOverviewCtx = document.getElementById('monthlyFinancesOverviewChart').getContext('2d');
        const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
        const attendanceOverviewCtx = document.getElementById('attendanceOverviewChart').getContext('2d');
        const financesDistributionCtx = document.getElementById('financesDistributionChart').getContext('2d');
        const departmentSavingsOverviewCtx = document.getElementById('departmentSavingsOverviewChart').getContext('2d');
        const departmentSavingsDistributionCtx = document.getElementById('departmentSavingsDistributionChart').getContext('2d');
        const genderDistributionCtx = document.getElementById('genderDistributionChart').getContext('2d');

        if (serviceAttendanceChart) {
            serviceAttendanceChart.destroy();
        }

        if (monthlyFinancesOverviewChart) {
            monthlyFinancesOverviewChart.destroy();
        }

        if (incomeExpenseChart) {
            incomeExpenseChart.destroy();
        }
        if (attendanceOverviewChart) {
            attendanceOverviewChart.destroy();
        }
        if (financesDistributionChart) {
            financesDistributionChart.destroy();
        }

        if (departmentSavingsOverviewChart) {
            departmentSavingsOverviewChart.destroy();
        }

        if (departmentSavingsDistributionChart) {
            departmentSavingsDistributionChart.destroy();
        }
        if (genderDistributionChart) {
            genderDistributionChart.destroy();
        }

        // Gender Distribution Pie Chart
        genderDistributionChart = new Chart(genderDistributionCtx, {
            type: 'pie',
            data: {
                labels: yearData.gender_distribution.labels,
                datasets: [{
                    data: yearData.gender_distribution.counts,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                        text: 'Gender Distribution'
                    }
                }
            }
        });


        // Service Attendance Pie Chart
        serviceAttendanceChart = new Chart(serviceAttendanceCtx, {
            type: 'pie',
            data: {
                labels: yearData.service_attendance.labels,
                datasets: [{
                    data: yearData.service_attendance.attendances,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                        text: 'Service Attendance Distribution'
                    }
                }
            }
        });
        // Department Savings Overview Line Chart
        departmentSavingsOverviewChart = new Chart(departmentSavingsOverviewCtx, {
            type: 'line',
            data: {
                labels: yearData.monthly_department_savings.labels,
                datasets: [{
                    label: 'Savings (Kes)',
                    data: yearData.monthly_department_savings.savings,
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Department Savings Distribution Pie Chart
        departmentSavingsDistributionChart = new Chart(departmentSavingsDistributionCtx, {
            type: 'pie',
            data: {
                labels: yearData.monthly_department_savings_metrics.labels,
                datasets: [{
                    data: yearData.monthly_department_savings_metrics.savings,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                        text: 'Department Savings Distribution'
                    }
                }
            }
        });
        
        // Finances Distribution Pie Chart
        financesDistributionChart = new Chart(financesDistributionCtx, {
            type: 'pie',
            data: {
                labels: yearData.net_financials.labels,
                datasets: [{
                    data: yearData.net_financials.data,
                    backgroundColor: [
                        '#36A2EB',
                        '#FF6384',
                        '#FFCE56'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false,
                        text: 'Financial Distribution'
                    }
                }
            }
        });

      // Attendance Overview Line Chart
        attendanceOverviewChart = new Chart(attendanceOverviewCtx, {
            type: 'line',
            data: {
                labels: yearData.general_attendance_metrics.labels,
                datasets: yearData.general_attendance_metrics.datasets.map(dataset => {
                    const colors = colorMap[dataset.label] || {
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    };

                    const isOverall = dataset.label === "Overall Attendance";

                    return {
                        label: dataset.label,
                        data: dataset.data,
                        borderColor: colors.borderColor,
                        backgroundColor: colors.backgroundColor,
                        borderWidth: isOverall ? 3 : 2,
                        //borderDash: isOverall ? [5, 5] : [],
                        tension: 0.3,
                        fill: !isOverall,      // Fill only for gender lines
                        pointRadius: isOverall ? 4 : 3,
                        pointStyle: isOverall ? 'rectRot' : 'circle',
                    };
                })
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                stacked: false,
                plugins: {
                    title: {
                        display: false,
                        text: 'Monthly Attendance by Gender and Overall',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                        },
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: false,
                            text: 'Attendance Count',
                        },
                        grid: {
                            color: 'rgba(200,200,200,0.2)',
                        },
                    },
                    x: {
                        title: {
                            display: false,
                            text: 'Month',
                        },
                    },
                },
            },
        });
        // Income vs Expense Line Chart
        incomeExpenseChart = new Chart(incomeExpenseCtx, {
            type: 'line',
            data: {
                labels: yearData.income_expense.labels,
                datasets: [
                    {
                        label: 'Income (Kes)',
                        data: yearData.income_expense.income,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: 'Expense (Kes)',
                        data: yearData.income_expense.expense,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Monthly Offerings Line Chart
        monthlyFinancesOverviewChart = new Chart(monthlyFinancesOverviewCtx, {
            type: 'line',
            data: {
                labels: yearData.monthly_finances.labels,
                datasets: [{
                    label: 'Offerings (Kes)',
                    data: yearData.monthly_finances.offerings,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'Donations (Kes)',
                    data: yearData.monthly_finances.donations,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    tension: 0.1,
                    fill: true,
                },
                {
                    label: 'Tithes (Kes)',
                    data: yearData.monthly_finances.tithes,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true,
                }
            ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Initialize charts on page load


    document.addEventListener('DOMContentLoaded', function() {
        initCharts(initialData);
        
        // Year filter change event
        document.getElementById('yearFilter').addEventListener('change', function() {
            const selectedYear = this.value;
            
            // Fetch data for the selected year
            fetch(`/api/chart-data/?year=${selectedYear}`)
                .then(response => response.json())
                .then(data => {
                    // Update charts
                    initCharts(data);
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                });
        });
    });
    
    
    </script>
{% endblock additional_scripts %}
